.. sectionauthor:: Артём Светлов <artem.svetlov@nextgis.ru>

.. _admin_tasks:

Административные задачи
================================

Создание групп пользователей
--------------------------------

Диалог создания новой группы представлен на :numref:`admin_controlpanel_usergroup_create`. Для открытия этого окна необходимо открыть панель управления (см. :numref:`admin_control_panel`) и выбрать там: :menuselection:`Группы пользователей --> Создать`.

.. figure:: _static/admin_controlpanel_usergroup_create.png
   :name: admin_controlpanel_usergroup_create
   :align: center

   Создание новой группы

В диалоге необходимо указать полное и краткое наименование группы и нажать кнопку :guilabel:`Создать`. Полное наименование служит в качестве описания. Название группы должно содержать только цифры и буквы. 


Создание пользователя
--------------------------------

Диалог создания нового пользователя представлен на :numref:`admin_controlpanel_user_create`. Для открытия этого окна необходимо открыть панель управления (см. :numref:`admin_control_panel`) и выбрать там: :menuselection:`Пользователи --> Создать`.

В диалоге необходимо указать:

* Полное имя пользователя (например, Иванов Иван Иванович)
* Имя пользователя – логин (например, ivanov)
* Пароль

Выбрать к какой группе относится пользователь – в списке будут отображены имеющиеся группы. Если необходимой группы в списке нет, то ее необходимо создать (см. Создание групп пользователей).

Далее необходимо нажать кнопку :guilabel:`Создать`.

.. figure:: _static/admin_controlpanel_user_create.png
   :name: admin_controlpanel_user_create
   :align: center

   Окно создания пользователя


Управление правами доступа
--------------------------------

Права доступа могут настраиваться для ###############. Для настройки прав доступа необходимо открыть ########### и выбрать #################################################. Если у вас сложная система с несколькими отдельными картами, и с ней должны работать разные пользователи, то можно создать группы пользователей. Для групп можно настраивать права доступа по отдельности.


Для настройки прав доступа не всех слоев/карт, а отдельных, слоев, групп слоев, веб-карт следует использовать пункт Операции → Управление доступом на странице свойств соответствующих элементов.




Миграция
----------------------------------

Основные сведения
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Миграция – это процедура по переносу данных и настроенной NextGIS Web между серверами. В ходе процедуры миграции создается резервная копия, в которую записывается:

* Всё содержимое базы данных NextGIS Web: информация о слоях, стили, аккаунты пользователей, то есть всё, что настраивается в интерфейсе администратора
* Векторные данные, которые были загружены через интерфейс администратора.
* Растровые данные, которые были загружены через интерфейс администратора. 

Файл config.ini в резервную копию не включаются, их надо переносить отдельно.

Для запуска процедуры миграции необходимо выполнять следующие команды:

.. code:: bash

	$ env/bin/nextgisweb --config config.ini backup file.ngwbackup
	$ env/bin/nextgisweb --config config.ini restore file.ngwbackup

Резервная копия – это ZIP-архив. Для отключения архивации резервной копии необходимо указать ключ —no-zip. При это будет создан новый каталог, с указанным именем.

.. code:: bash

	$ env/bin/nextgisweb  --config "config.ini" backup "backup/ngwbackup" --no-zip

В ОС FreeBSD есть ошибка: поддержка sqlite не переносится virtualenv. Нужно вручную скопировать файл:

.. code:: bash

	$ cp /usr/local/lib/python2.7/site-packages/_sqlite3.so  env/lib/python2.7/site-packages/


Порядок миграции
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. На старом сервере запускается процедура резервного копирования.

.. code:: bash

	$ env/bin/nextgisweb  --config "config.ini" backup "backup/ngwbackup" --no-zip

2. Если необходимо перенести базу PostGIS с геоданными, то со старого сервера делаем ее резервная копия программой pgAdminIII в формате tar.
3. На новом сервере устанавливаем NextGIS Web согласно инструкции (см. разд. 2).
4. На новом сервере создается база данных для NextGIS Web, и настраиваются  права доступа программой pgAdminIII.
5. На новом сервере в файле config.ini необходимо указать подключение к базе NextGIS Web.

 
.. code::

	# Имя сервера БД 
	database.host = localhost
	# Имя БД на сервере 
	database.name = zapoved_ngw
	# Имя пользователя БД 
	database.user = user
	# Пароль пользователя БД 
	database.password = password


6. На новом сервере выполняем команду: 

.. code:: bash

	$ env/bin/nextgisweb  --config "config.ini" restore "backup/ngwbackup"

7. Запустите NextGIS Web. Должно работать всё, кроме слоёв PostGIS (при их наличии)

8. Если необходимо перенести базу PostGIS с геоданными, то создается новая база данных, в нее разворачивается резервная копия со старого сервера
9. В настройках подключений PostGIS указывается новый адрес сервера. 

Если появляется ошибка "No module named pysqlite2" - значит при установке вы забыли перенести sqlite. Выполните нужную команду из инструкции по установке.








