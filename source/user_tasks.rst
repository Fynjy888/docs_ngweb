.. sectionauthor:: Артём Светлов <artem.svetlov@nextgis.ru>

.. _user_tasks:

Пользовательские задачи
================================

Создание слоя
--------------------------

Одним из основных компонентов ПО NextGIS Web является слой. Слой это растровое изображение и векторный файл (таблица БД). Для объединения слоев в виде карты необходимо настроить стиль (или набор стилей) отображения слоя.

Стили могут настраиваться только для векторных слоев.

Интерфейс добавления PostGIS, векторных и растровых слоев приблизительно одинаковый. Нужно ввести параметры слоя, затем добавить стиль.

Растровый слой
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для добавления растрового слоя перейдите в группу, где необходимо его создать. В блоке операций выберите :menuselection:`Добавить --> Растровый слой`. Откроется окно представленное на :numref:`admin_layers_create_raster_layer_resourse_description`. 

.. figure:: _static/admin_layers_create_raster_layer_resourse_description.png
   :name: admin_layers_create_raster_layer_resourse_description
   :align: center


Введите наименование слоя, которое будет отображаться в в административном веб интерфейсе, а также в дереве слоев карт.
Поля «Ключ» и «Описание» являются необязательными параметрами.

Переключитесь со вкладки «Ресурс» на вкладку «Растровый слой». Откроется окно представленное на :numref:`admin_layers_create_raster_layer_upload`.

.. figure:: _static/admin_layers_create_raster_layer_upload.png
   :name: admin_layers_create_raster_layer_upload
   :align: center

Далее необходимо выбрать систему координат в которую будет перепроецирован растр (по-умолчанию имеется только WGS84 / Pseudo Mercator (EPSG:3857) ).
Далее необходимо указать сам файл. 

.. note:: Файл может быть только формата GeoTIFF с 3 или 4 каналами (RGB или RGBA). 
 
Большинство утилит не создают альфа канал, а только добавляют значение NoData. Для преобразования значений NoData в альфа канал можно воспользоваться утилитой командной строки gdalwarp. Ниже приведен пример команды.

.. code:: shell

    gdalwarp -t_srs EPSG:3857 -multi -dstalpha -dstnodata none -wo "UNIFIED_SRC_NODATA=YES" -co COMPRESS=JPEG d:\temp\o\ast_20010730_010043_rgb.tif d:\temp\o\ast_20010730_010043_rgba.tif


После удачной загрузки растра необходимо создать стиль (если он не был создан автоматически). 
При создании карты (подробнее см. подразд. 4.4) можно добавлять растр на карту, выбрав растр и его стиль.

.. note:: В NextGIS Manager эту операцию можно сделать проще. В програме есть функционал загрузки растра в NextGIS Web и обрезки по альфа-каналу. 















Векторный слой из файла
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Введите наименование слоя, которое будет отображаться в в административном веб интерфейсе, а также в дереве слоев карты. 

Поля «Ключ» и «Описание» являются необязательными параметрами. 

Переключитесь со вкладки «Ресурс» на вкладку «Векторный слой». Откроется окно представленное на :numref:`admin_layers_create_vector_layer_resourse_description`. 

.. figure:: _static/admin_layers_create_vector_layer_resourse_description.png
   :name: admin_layers_create_vector_layer_resourse_description
   :align: center

Далее необходимо выбрать систему координат в которую будет перепроецированы векторные данные (по-умолчанию имеется только WGS84 / Pseudo Mercator (EPSG:3857) ). 

Далее необходимо указать сам файл. 

.. note:: Файл может быть только формата ESRI Shapefie. При этом все составляющие его части (dbf, shp, shx, prj и др.) должны быть упакованы в архив формата zip. 


.. figure:: _static/admin_layers_create_vector_layer_upload.png
   :name: admin_layers_create_vector_layer_upload
   :align: center

Кроме того, необходимо указать кодировку в которой записаны атрибуты. Если кодировка не указана, то данные должен сопровождать файл с описание кодировки (расширение cpg). 

После удачной загрузки векторного файла необходимо создать стиль. Подробнее о создании стилей описано в подразд. 4.3

При создании карты (подробнее см. подразд. 4.4) можно добавлять векторный слой на карту указывая его стиль.

.. note:: В NextGIS Manager эту операцию можно сделать проще. В програме есть функционал загрузки в NextGIS Web векторных файлов разных форматов, без необходимости отдельного архивирования. 










:menuselection:`Добавить --> Cоединение с PostGIS`




Векторный слой из PostGIS
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для добавления векторного слоя из БД PostgreSQL с модулем расширения PostGIS необходимо сначала создать ресурс — соединение с PostGIS. Вам достаточно создать одно подключение. В блоке операций выберите :menuselection:`Добавить --> Cоединение с PostGIS`. Откроется окно представленное на :numref:`admin_layers_create_postgis_connection_resourse_description`. 

.. figure:: _static/admin_layers_create_postgis_connection_resourse_description.png
   :name: admin_layers_create_postgis_connection_resourse_description
   :align: center
   :alt: map to buried treasure

   Окно добавления соединения PostGIS

Введите наименование подключения, которое будет отображаться в в административном веб интерфейсе. Не путайте потом это название и название слоёв в базе данных. 

Поля «Ключ» и «Описание» являются необязательными параметрами. 

Переключитесь со вкладки «Ресурс» на вкладку «Cоединение с PostGIS». Откроется окно представленное на numref:`admin_layers_create_postgis_connection_db_logins`. 


Далее необходимо ввести параметры подключения к базе данных PostGIS, из которой будут отображаться ваши данные.  

.. figure:: _static/admin_layers_create_postgis_connection_db_logins.png
   :name: admin_layers_create_postgis_connection_db_logins
   :align: center


Далее можно приступать к добавлению отдельных слоёв PostGIS. Перейдите в группу, где необходимо их создать. В блоке операций выберите :menuselection:`Добавить --> Слой PostGIS`. Откроется окно представленное на :numref:`admin_layers_create_postgis_layer_resourse_description`. 

.. figure:: _static/admin_layers_create_postgis_connection_resourse_description.png
   :name: admin_layers_create_postgis_layer_resourse_description
   :align: center
   Подпись к фигуре

Введите наименование слоя, которое будет отображаться в в административном веб интерфейсе, а также в дереве слоев карты. 
Поля «Ключ» и «Описание» являются необязательными параметрами. 
Переключитесь со вкладки «Ресурс» на вкладку «Cлой PostGIS». Откроется окно представленное на :numref:`admin_layers_create_postgis_layer_tablename`. 

.. figure:: _static/admin_layers_create_postgis_layer_tablename.png
   :name: admin_layers_create_postgis_layer_tablename
   :align: center

Далее необходимо:

#. Из выпадающего списка выбрать подключение к БД, (Создание описано в этом же пункте, чуть выше)
#. Ввести схему БД в которой находится слой PostGIS.
.. note:: В одной базе данных PostgreSQL может быть несколько схем, внутри каждой схемы лежат таблицы и представления. Если схема одна, то она называется public. Подробнее смотрите в руководствах по СУБД PostgreSQL.
#. Ввести название таблицы ( слоя PostGIS). Вам потребуется знать названия ваших таблиц и полей в базе данных. 
.. note:: Отображение таблиц и представлений не входит в задачи NextGIS Web. Для просмотра можно воспользоваться NextGIS Manager или PgAdmin.
#. Ввести поле ID (при загрузке данных в PostGIS через NextGIS Manager обычно создается поле с названием ogc_fid, при загрузки иным способом название поля может отличаться).
.. note:: Поле ID должно удовлетворять ограничениям на тип данных: быть числовым (**numeric**) и являться первичным ключом.
#. Ввести имя поля геометрии (при загрузке данных в PostGIS через NextGIS Manager обычно создается поле геометрии с названием wkb_geometry, при загрузки иным способом название поля может отличаться).
#. Поля «Тип геометрии», «Система координат» и «Описание атрибутов» не обязательными и могут быть оставлены по-умолчанию.

.. note:: Программное обеспечение NextGIS Web поддерживает добавление таблиц, в которых в поле геометрии хранятся вперемежку точечные, линейные и полигональные геометрии. Это необходимо для отображения специфических наборов данных: например если в одной таблице хранятся координаты городских парков в виде полигонов, и мусорных урн в виде точек. В этом случае в NextGIS Web нужно добавить три отдельных слоя для каждого типа геометрии, и выбрать нужный элемент в поле «Тип геометрии».

После создания слоя для отображения подписей к геометриям необходимо задать атрибут наименования. Для этого зайдите на страницу редактирования слоя и выберите нужное поле в списке «Атрибут наименования».

Если в БД были изменены какие либо данные касающиеся структуры (названия или типы полей, изменен их состав, переименованы таблицы и т. п.), то в свойствах соответствующего слоя необходимо обновить описания атрибутов. Для этого, следует выбрать редактирование слоя → Описания атрибутов → Прочитать из базы данных нажать "Сохранить".

Создание слоя с условиями
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

В NextGIS Web нельзя указывать условия отбора записей из слоя (SQL конструкция WHERE). Это делается для обеспечения безопасности (исключения атак SQL Injection). Для обеспечения такой возможности необходимо в БД создать представления с соответствующими условиями отбора.

Для этого необходимо подключится к БД PostgreSQL/PostGIS при помощи pgAdminIII, перейти в схему данных, где следует создать представление и в элементе дерева «представления» правой клавишей мыши вызвать контекстное меню и выбрать «Создать новое представления» (см. рис. 4.9 п. 1). Также диалог можно вызвать правым кликом на названии схемы выбрав «Новый объект → Новое представление».
Далее, в открывшемся диалоге необходимо указать:
#. Название представления (вкладка «Свойства»).
#. Схему данных в которой необходимо создать представление (вкладка «Свойства»).
#. Необходимый SQL запрос (вкладка «Определение»).
После этого, не выходя из pgAdminIII можно открыть представление для проверки корректности введенного SQL запроса (см. рис. 4.9 п. 2). 

